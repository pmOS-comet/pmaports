# Co-Maintainer: Achill Gilgenast <achill@achill.org>
maintainer="Aelin <aelin@postmarketos.org>"
pkgname=linux-postmarketos-lts
pkgver=6.18.7
pkgrel=0
_kver=${pkgver%.*}
pkgdesc="LTS Kernel"
# armhf: pmbootstrap cannot dynamically choose a defconfig, so it ends up using multi_v7_defconfig which isn't correct
# s390x: kconfigcheck is not ready for it yet
arch="all !armhf !s390x"
_flavor="lts"
url="https://kernel.org"
license="GPL-2.0-only"
options="
	!check
	!strip
	!tracedeps
	pmb:cross-native
	pmb:generic-kernel
	pmb:kconfigcheck-community
	pmb:kconfigcheck-immutable
	pmb:kconfigcheck-rust
	pmb:kconfigcheck-uefi
	pmb:kconfigcheck-virt
"
makedepends="
	bison
	clang
	clang-libclang
	diffutils
	elfutils-dev
	findutils
	flex
	linux-headers
	lld
	llvm
	openssl-dev
	pahole
	perl
	postmarketos-installkernel
	python3
	rust
	rust-bindgen
	rust-src
	rustfmt
	sed
	zstd
"
replaces="linux-lts"

# Source
source="
	linux-$_kver.tar.xz::https://cdn.kernel.org/pub/linux/kernel/v${pkgver%%.*}.x/linux-$_kver.tar.xz

	config-lts.aarch64
	config-lts.armv7
	config-lts.loongarch64
	config-lts.ppc64le
	config-lts.riscv64
	config-lts.x86
	config-lts.x86_64
"
builddir="$srcdir/linux-$_kver"
_defconfig="defconfig"

if [ "${pkgver%.0}" = "$pkgver" ]; then
	# Prepend to apply first
	source="patch-$pkgver.patch.xz::https://cdn.kernel.org/pub/linux/kernel/v${pkgver%%.*}.x/patch-$pkgver.xz $source"
fi

case "$CARCH" in
	aarch64*) _carch="arm64" ;;
	arm*) _carch="arm" ;;
	loongarch*) _carch="loongarch" ;;
	ppc*) _carch="powerpc" ;;
	riscv*) _carch="riscv" ;;
	s390x) _carch="s390" ;;
	x86) _carch="i386" ;;
	x86_64) _carch="x86_64" ;;
esac

prepare() {
	default_prepare
	cp "$srcdir/config-$_flavor.$CARCH" .config
}

build() {
	unset LDFLAGS
	make ARCH="$_carch" LLVM=1 \
		KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-$_flavor"
}

package() {
	local _install
	case "$CARCH" in
		arm*|aarch64|riscv*) _install="zinstall dtbs_install" ;;
		*) _install="install" ;;
	esac

	make modules_install $_install \
		ARCH="$_carch" \
		LLVM=1 \
		INSTALL_PATH="$pkgdir"/boot/ \
		INSTALL_MOD_PATH="$pkgdir" \
		INSTALL_MOD_STRIP=1 \
		INSTALL_DTBS_PATH="$pkgdir"/boot/dtbs-$_flavor

	rm -f "$pkgdir"/lib/modules/*/build "$pkgdir"/lib/modules/*/source

	install -D "$builddir"/include/config/kernel.release \
		"$pkgdir"/usr/share/kernel/$_flavor/kernel.release
}

sha512sums="
90fb319e2aa32c4b7d7070205ac7228139de96e7fb1bfdcb5ed9a48c85df739d80e043d31a4216a3a0561aaa80a6b4198bf2000d185a5850f36ef0aa31ed52c6  patch-6.18.7.patch.xz
88599ffdec96d150c1feb9b261ba93bb0301a9d0e1ad6bef7aeab1f5372cbfc57d8b43c7e902bd8f76921d1dbd8189663c142ea869e51d0e2b483b150ee00fe0  linux-6.18.tar.xz
66e875bdd44a1f7feffc306e7ec2e2dee65da3bdfc5c5a4cb57a0ca4fceed781de76825b208b71a1ee1aa2268501abcf2a8ee6ab0283812bd903b28d96018191  config-lts.aarch64
7fd055cc94b5982c5fdf928eb69693101efe1b4f7cb7e4ce1a08a148b35b78ec35c54e9a631bd50739e4fed3cdcbc03f35b1369866a98dbcd5c1ff660c00e92c  config-lts.armv7
de034bee6525c55b88e579588bd94d0534d97c6193bc053df62cd32a9d8b3a14cc7c83f3672b481992611edcf9efba382e4c4e32ad2249ec3155dee1bae5e2d6  config-lts.loongarch64
ded35141924c4c57d256787cd5a6424d40cd6ed642a771e624da42cdf470ede5436c067da1b655d80ca6f6119b85290fd80be52b85c6abbb2ff103ee52fca97f  config-lts.ppc64le
d8220b0d5d2a13db65cc81a04487bcf47e8023e4c2f60ef57b4de45976527be2b74f9c7f729834d6efa10750ee665f374f33d45850106cd3036c9ded7cee8aea  config-lts.riscv64
e1e243255711668eece7fc0463ed9d69de2e29bd87dc0e0256fcfa3b5ccf93cdcf24529e89f942d508eccd7e4b4938283e9d8549d785bb2e9ab082db44e48b44  config-lts.x86
25027314bdd55f8ac55da7616f446008fc4ad178e137d01ec58c72dee721b8c4274f974ae4e2009d39d3f43f9c5f6c4bced50203f250d2760511c3a97e708dd6  config-lts.x86_64
"
