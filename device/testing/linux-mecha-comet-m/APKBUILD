pkgname=linux-mecha-comet-m
pkgver=6.6.52
pkgrel=0
# NOTE: Don't forget to rebase the config! See prepare() for instructions.
pkgdesc="Mecha Comet M kernel fork"
arch="aarch64"
_carch="arm64"
_flavor="mecha-comet-m"
url="https://github.com/pmOS-comet/linux"
license="GPL-2.0-only"
options="!strip !check !tracedeps
	pmb:cross-native
	pmb:kconfigcheck-community
	"
makedepends="
	bash
	bison
	devicepkg-dev
	findutils
	flex
	installkernel
	openssl-dev
	perl
	rsync
	xz
	"
install="$pkgname.post-upgrade"

# Source
_repository="linux-imx"
_config="config-$_flavor.$arch"
_tag="postmarketOS-devel-20251023-gen6"

source="
	$pkgname-linux-$pkgver.tar.gz::"$url/archive/refs/tags/$_tag.tar.gz"
	$_config
"
builddir="$srcdir/$_repository-$_tag"

prepare() {
	default_prepare
	REPLACE_GCCH=0 \
		. downstreamkernel_prepare
}

build() {
	unset LDFLAGS
	make ARCH="$_carch" CC="${CC:-gcc}" \
		KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-postmarketOS"
}

package() {
	downstreamkernel_package "$builddir" "$pkgdir" "$_carch" "$_flavor"

	make modules_install dtbs_install \
		ARCH="$_carch" \
		INSTALL_PATH="$pkgdir"/boot \
		INSTALL_MOD_PATH="$pkgdir" \
		INSTALL_DTBS_PATH="$pkgdir/boot/dtbs"

}
sha512sums="
7897bd53a4674cf114b650b1a21b659b4ae77ecfd6de9931ed4ead157807f2b866de11f3f24bf1f8df0c78828e2e52319ff1dd99acfe10aab98612b8747a948e  linux-mecha-comet-m-linux-6.6.52.tar.gz
f3d4b4a66003b2d3e68fd41d46f7b12ecffa0c025fe779bff9a9bb2071aa6c900900b123a7bc6128b8e90e60deb8af777b8eb59131dac731ea0f84a2ed48ed4f  config-mecha-comet-m.aarch64
"
