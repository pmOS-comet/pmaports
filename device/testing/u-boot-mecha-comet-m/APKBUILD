pkgname=u-boot-mecha-comet-m
pkgver=2023.04
pkgrel=1
# U-Boot version
_uboot_ver="imx-2023.04.y"
# IMX-ATF release
_atf_url="https://github.com/nxp-imx/imx-atf"
_atf_commit="99195a23d3aef485fb8f10939583b1bdef18881c"
# IMX-mkimage release
# TODO: move to upstream imx-mkimage
_imxmkimage_url="https://github.com/ersascape/imx-mkimage" 
_imxmkimage_commit="imx-mecha"
_firmwareversion="8.20"
pkgdesc="u-boot bootloader for the Mecha Comet"
url="https://github.com/pmOS-comet/u-boot"
arch="aarch64"
license="GPL-2.0-or-later OFL-1.1 BSD-2-Clause BSD-3-Clause eCos-2.0 IBM-pibs"
makedepends="
	bash
	bc
	binutils
	bison
	coreutils
	dtc
	flex
	gnutls-dev
	openssl-dev
	perl
	py3-setuptools
	python3-dev
	swig
	util-linux-dev
	zlib-dev
	"
options="!check !tracedeps pmb:cross-native"
source="
	u-boot-imx-mecha-comet.tar.gz::$url/archive/refs/heads/$_uboot_ver.tar.gz
	arm-trusted-firmware-$_atf_commit.tar.gz::$_atf_url/archive/$_atf_commit.tar.gz
	imx_mkimage-$_imxmkimage_commit.tar.gz::$_imxmkimage_url/archive/refs/tags/$_imxmkimage_commit.tar.gz
	https://www.nxp.com/lgfiles/NMG/MAD/YOCTO/firmware-imx-$_firmwareversion.bin
	update-u-boot
	"
install="$pkgname.post-upgrade"

_atf_builddir="$srcdir/imx-atf-$_atf_commit"
_firmware_builddir="$srcdir/firmware-imx-$_firmwareversion"
_imxmkimage_dir="$srcdir/imx-mkimage-$_imxmkimage_commit"
builddir="$srcdir/u-boot-$_uboot_ver"

prepare() {
	default_prepare

	msg "Extracting DDR & HDMI firmware"
	cd "$srcdir"
	chmod +x firmware-imx-$_firmwareversion.bin
	./firmware-imx-$_firmwareversion.bin --auto-accept
	cp -v "$_firmware_builddir"/firmware/ddr/synopsys/lpddr4*.bin $builddir/
	cp -v "$_firmware_builddir"/firmware/hdmi/cadence/signed_*imx8m.bin $builddir/

	# Disable -Werror in arm-trusted-firmware so it builds with GCC 12. The
	# version we use here is missing E=0 introduced here:
	# https://github.com/ARM-software/arm-trusted-firmware/commit/6336b07ad25cb05ca75f5a465d816af7956e0a59
	sed -i "s/-Werror//g" "$_atf_builddir"/Makefile
}

build() {
	msg "Building ARM trusted firmware"
	cd "$_atf_builddir"
	LDFLAGS="-no-warn-rwx-segment" make PLAT=imx8mm bl31
	# Overwrite default bl31 binary with one made here
	export BL31="$_atf_builddir/build/imx8mm/release/bl31.bin"
	cp -v "$_atf_builddir"/build/imx8mm/release/bl31.bin "$builddir"/

	msg "Building u-boot"
	cd $builddir

	# Phone uboot firmware
	make distclean
	make mecha_cometm_gen1_defconfig
	make CROSS_COMPILE=aarch64-alpine-linux-musl- -j$(nproc --all)

	# Generate IMX image
	cp "$builddir"/spl/u-boot-spl.bin "$_imxmkimage_dir"/iMX8M/u-boot-spl.bin
	cp "$builddir"/u-boot-nodtb.bin "$_imxmkimage_dir"/iMX8M/u-boot-nodtb.bin
	cp "$builddir"/arch/arm/dts/mecha-comet.dtb "$_imxmkimage_dir"/iMX8M/mecha-comet.dtb
        cp "$builddir"/arch/arm/dts/mecha-comet.dtb "$_imxmkimage_dir"/iMX8M/mecha-comet-evk.dtb
	install -Dm755 "$builddir"/tools/mkimage "$_imxmkimage_dir"/iMX8M/mkimage_uboot
	cp "$_atf_builddir"/build/imx8mm/release/bl31.bin "$_imxmkimage_dir"/iMX8M/bl31.bin
        cp -v "$_firmware_builddir"/firmware/ddr/synopsys/lpddr4*.bin "$_imxmkimage_dir"/iMX8M/
        cp -v "$_firmware_builddir"/firmware/hdmi/cadence/signed_*imx8m.bin "$_imxmkimage_dir"/iMX8M/

        cd $_imxmkimage_dir
	make SOC=iMX8MM PLAT=mecha-comet flash_evk
        
	cp iMX8M/flash.bin "$builddir"/phone-boot.img
	sha512sum -b "$builddir"/phone-boot.img > "$builddir"/phone-boot.img.sha512
}

package() {
	install -D -m644 "$builddir"/phone-boot.img \
		"$pkgdir/usr/share/u-boot/comet-m/phone-boot.img"
	install -D -m644 "$builddir"/phone-boot.img.sha512 \
		"$pkgdir/usr/share/u-boot/comet-m/phone-boot.img.sha512"
	install -D -m 755 "$srcdir"/update-u-boot \
		"$pkgdir"/usr/sbin/update-u-boot
}
sha512sums="
cea0373f839c32039834a47ac8d95bf963bca48d67856ff3cc084881ebca0c12e02c7e9d8ecbe9ee8d51061021d2c37a6bd73121ae9204651fc5a8b605a59fc8  u-boot-imx-mecha-comet.tar.gz
d5ca3eea01a147952fbe18745080dce3ea0a29302befaccf3aeb33aa5f7837a8bb17060f53dd3843a604e9bef045d3e0aed5ce8f99b456aa96bcf1343a4bf06c  arm-trusted-firmware-99195a23d3aef485fb8f10939583b1bdef18881c.tar.gz
8302ab022132bf29ff5ba260d9ac01583fcb975784d74a8d1702b74cc149b25823a46fb332cf00838382d73ddd40d3ad8bff2047aa24fc2f299cf1428baaac6c  imx_mkimage-imx-mecha.tar.gz
34f69f773ce6a7cd0c00237e31ebbc9de1cfd61937a9ece3c6173876b5a47036c57a25ab8694c7c0ef33cecd7ca4de908fb9cede89349ef2b701eac7ab9d5b14  firmware-imx-8.20.bin
b1907626ceca8030926598413d6158ae3737f785334aa13a8e77e898a5e359f9cdda772a4e6463c1fd5c28dc0a1bb028f47a1816449c4b2e94db2274464124b1  update-u-boot
"
