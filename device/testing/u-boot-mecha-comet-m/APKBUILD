pkgname=u-boot-mecha-comet-m
pkgver=2025.04
pkgrel=1
# U-Boot version
_uboot_ver="imx-2025.04.y"
# IMX-ATF release
_atf_url="https://github.com/nxp-imx/imx-atf"
_atf_commit="a266ff458c2526a6474036a5c6648be6fdc54fe3"
# IMX-mkimage release
# TODO: move to upstream imx-mkimage
_imxmkimage_url="https://github.com/pmOS-comet/imx-mkimage" 
_imxmkimage_branch="lf-6.12.20_2.0.0"
# OP-TEE
_optee_url="https://github.com/nxp-imx/imx-optee-os"
_optee_branch="lf-6.12.49_2.2.0"
_firmwareversion="8.26-d4c33ab"
pkgdesc="u-boot bootloader for the Mecha Comet"
url="https://github.com/pmOS-comet/u-boot"
arch="aarch64"
license="GPL-2.0-or-later OFL-1.1 BSD-2-Clause BSD-3-Clause eCos-2.0 IBM-pibs"
makedepends="
	bash
	bc
	binutils
	bison
	coreutils
	dtc
	efitools
	flex
	gnutls-dev
	openssl-dev
	perl
	py3-cryptography
	py3-setuptools
	py3-elftools
	python3-dev
	swig
	util-linux-dev
	zlib-dev
	"
options="!check !tracedeps pmb:cross-native"
source="
	u-boot-$_uboot_ver.tar.gz::$url/archive/refs/heads/$_uboot_ver.tar.gz
	arm-trusted-firmware-$_atf_commit.tar.gz::$_atf_url/archive/$_atf_commit.tar.gz
	imx_mkimage-$_imxmkimage_branch.tar.gz::$_imxmkimage_url/archive/refs/heads/$_imxmkimage_branch.tar.gz
	imx-optee-os-$_optee_branch.tar.gz::$_optee_url/archive/refs/heads/$_optee_branch.tar.gz
	https://www.nxp.com/lgfiles/NMG/MAD/YOCTO/firmware-imx-$_firmwareversion.bin
	update-u-boot
	"
install="$pkgname.post-upgrade"

_atf_builddir="$srcdir/imx-atf-$_atf_commit"
_firmware_builddir="$srcdir/firmware-imx-$_firmwareversion"
_imxmkimage_dir="$srcdir/imx-mkimage-$_imxmkimage_branch"
_optee_dir="$srcdir/imx-optee-os-$_optee_branch"

builddir="$srcdir/u-boot-$_uboot_ver"

prepare() {
	default_prepare

	msg "Extracting DDR & HDMI firmware"
	cd "$srcdir"
	chmod +x firmware-imx-$_firmwareversion.bin
	./firmware-imx-$_firmwareversion.bin --auto-accept
	cp -v "$_firmware_builddir"/firmware/ddr/synopsys/lpddr4*.bin $builddir/
	cp -v "$_firmware_builddir"/firmware/hdmi/cadence/signed_*imx8m.bin $builddir/

	# Disable -Werror in arm-trusted-firmware so it builds with GCC 12. The
	# version we use here is missing E=0 introduced here:
	# https://github.com/ARM-software/arm-trusted-firmware/commit/6336b07ad25cb05ca75f5a465d816af7956e0a59
	sed -i "s/-Werror//g" "$_atf_builddir"/Makefile
}

build() {
	msg "Building ARM trusted firmware"
	cd "$_atf_builddir"
	make PLAT=imx8mp BUILD_BASE=build-optee SPD=opteed bl31
	# Overwrite default bl31 binary with one made here
	export BL31="$_atf_builddir/build-optee/imx8mp/release/bl31.bin"
	cp -v "$_atf_builddir"/build-optee/imx8mp/release/bl31.bin "$builddir"/

	# Buld OP-TEE
	msg "Building OP-TEE"
	cd "$_optee_dir"
	make -j$(nproc --all) PLATFORM=imx-mx8mpevk LDFLAGS= \
		CROSS_COMPILE=aarch64-alpine-linux-musl- \
		CROSS_COMPILE64=aarch64-alpine-linux-musl- \
		CFG_TEE_TA_LOG_LEVEL=0 CFG_TEE_CORE_LOG_LEVEL=0 \
		O=build.imx-mx8mpevk

	# Phone uboot firmware
	msg "Building U-Boot"
	cd "$builddir"
	make distclean
	make mecha-comet-imx8mp_defconfig
	make CROSS_COMPILE=aarch64-alpine-linux-musl- -j$(nproc --all)

	# Generate IMX image
	cp "$builddir"/spl/u-boot-spl.bin "$_imxmkimage_dir"/iMX8M/u-boot-spl.bin
	cp "$builddir"/u-boot-nodtb.bin "$_imxmkimage_dir"/iMX8M/u-boot-nodtb.bin
	cp "$builddir"/arch/arm/dts/imx8mp-mecha-comet.dtb "$_imxmkimage_dir"/iMX8M/imx8mp-mecha-comet.dtb
        cp "$builddir"/arch/arm/dts/imx8mp-mecha-comet.dtb "$_imxmkimage_dir"/iMX8M/imx8mp-mecha-comet-evk.dtb
	install -Dm755 "$builddir"/tools/mkimage "$_imxmkimage_dir"/iMX8M/mkimage_uboot
	cp "$_atf_builddir"/build-optee/imx8mp/release/bl31.bin "$_imxmkimage_dir"/iMX8M/bl31.bin
	cp "$_optee_dir"/build.imx-mx8mpevk/core/tee-raw.bin "$_imxmkimage_dir"/iMX8M/tee.bin
        cp -v "$_firmware_builddir"/firmware/ddr/synopsys/lpddr4*.bin "$_imxmkimage_dir"/iMX8M/
        cp -v "$_firmware_builddir"/firmware/hdmi/cadence/signed_*imx8m.bin "$_imxmkimage_dir"/iMX8M/

        cd $_imxmkimage_dir
	make SOC=iMX8MP PLAT=imx8mp-mecha-comet flash_evk
        
	cp iMX8M/flash.bin "$builddir"/phone-boot.img
	sha512sum -b "$builddir"/phone-boot.img > "$builddir"/phone-boot.img.sha512
}

package() {
        install -D -m644 "$_optee_dir"/build.imx-mx8mpevk/core/tee.bin \
               "$pkgdir/usr/lib/firmware/tee.bin"
        install -D -m644 "$_optee_dir"/build.imx-mx8mpevk/core/tee.bin \
                "$pkgdir/usr/lib/firmware/tee-raw.bin"
        install -D -m644 "$_optee_dir"/build.imx-mx8mpevk/core/tee.bin \
                "$pkgdir/usr/lib/firmware/tee-header_v2.bin"
        install -D -m644 "$_optee_dir"/build.imx-mx8mpevk/core/tee.bin \
                "$pkgdir/usr/lib/firmware/tee-pageable_v2.bin"
        install -D -m644 "$_optee_dir"/build.imx-mx8mpevk/core/tee.bin \
                "$pkgdir/usr/lib/firmware/tee-pager_v2.bin"

        install -d "$pkgdir/usr/lib/optee_armtz/"
        install -m444 "$_optee_dir"/build.imx-mx8mpevk/ta/*/*.ta \
                "$pkgdir/usr/lib/optee_armtz/"

	install -D -m644 "$builddir"/phone-boot.img \
		"$pkgdir/usr/share/u-boot/comet-m/phone-boot.img"
	install -D -m644 "$builddir"/phone-boot.img.sha512 \
		"$pkgdir/usr/share/u-boot/comet-m/phone-boot.img.sha512"
	install -D -m 755 "$srcdir"/update-u-boot \
		"$pkgdir"/usr/sbin/update-u-boot
}
sha512sums="
5a3176f2cc1e54568f8d6e924ac0c5e5b5502cdb8f129017e5afdccde7859d52cf7c72ebb9715d87ed4ce10948b1c268804dcde7162ab700e0180079a1177cd0  u-boot-imx-2025.04.y.tar.gz
2899950a02562ca5749589442984822b96dabeea6094583d88c3c2046ea89b4bc572034cf2f0003eec1bce9b266f3f119b39f517b1a80f4d26d26b3a35cd8b49  arm-trusted-firmware-a266ff458c2526a6474036a5c6648be6fdc54fe3.tar.gz
af2c0192e584a781b8b1de7643048ef6ac2997a4b0181de9a7d0d06e82ac380e2765cd048f899d443aa70321fc1525e146ff62191e60d894a60fc0cde020779d  imx_mkimage-lf-6.12.20_2.0.0.tar.gz
8c14da5e5d74d6525fcaa68f946fb50e550e82fefc3ed6060db471f566c6156714348b5f1caf7819699e77799a3a3de411e097e449c94eaa32f83f1442f3139c  imx-optee-os-lf-6.12.49_2.2.0.tar.gz
332c5856dd219c076c903818227accbbaffe4b9fd0d54605e7a9d4f7c8dc5ed38285e1e65df055d1f7e3d297a48b286688bd7c4152d1d745bdb3cefd86c6a38f  firmware-imx-8.26-d4c33ab.bin
b1907626ceca8030926598413d6158ae3737f785334aa13a8e77e898a5e359f9cdda772a4e6463c1fd5c28dc0a1bb028f47a1816449c4b2e94db2274464124b1  update-u-boot
"
