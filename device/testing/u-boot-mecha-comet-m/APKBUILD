pkgname=u-boot-mecha-comet-m
pkgver=2024.04
pkgrel=1
# U-Boot version
_uboot_ver="imx-2024.04.y"
# IMX-ATF release
_atf_url="https://github.com/nxp-imx/imx-atf"
_atf_commit="1b27ee3edbb40ef9432c69ccaa744d1ac5d54c5d"
# IMX-mkimage release
# TODO: move to upstream imx-mkimage
_imxmkimage_url="https://github.com/pmOS-comet/imx-mkimage" 
_imxmkimage_branch="lf-6.6.52-2.2.0"
_firmwareversion="8.26-d4c33ab"
pkgdesc="u-boot bootloader for the Mecha Comet"
url="https://github.com/pmOS-comet/u-boot"
arch="aarch64"
license="GPL-2.0-or-later OFL-1.1 BSD-2-Clause BSD-3-Clause eCos-2.0 IBM-pibs"
makedepends="
	bash
	bc
	binutils
	bison
	coreutils
	dtc
	flex
	gnutls-dev
	openssl-dev
	perl
	py3-setuptools
	python3-dev
	swig
	util-linux-dev
	zlib-dev
	"
options="!check !tracedeps pmb:cross-native"
source="
	u-boot-imx-mecha-comet.tar.gz::$url/archive/refs/heads/$_uboot_ver.tar.gz
	arm-trusted-firmware-$_atf_commit.tar.gz::$_atf_url/archive/$_atf_commit.tar.gz
	imx_mkimage-$_imxmkimage_branch.tar.gz::$_imxmkimage_url/archive/refs/heads/$_imxmkimage_branch.tar.gz
	https://www.nxp.com/lgfiles/NMG/MAD/YOCTO/firmware-imx-$_firmwareversion.bin
	update-u-boot
	"
install="$pkgname.post-upgrade"

_atf_builddir="$srcdir/imx-atf-$_atf_commit"
_firmware_builddir="$srcdir/firmware-imx-$_firmwareversion"
_imxmkimage_dir="$srcdir/imx-mkimage-$_imxmkimage_branch"
builddir="$srcdir/u-boot-$_uboot_ver"

prepare() {
	default_prepare

	msg "Extracting DDR & HDMI firmware"
	cd "$srcdir"
	chmod +x firmware-imx-$_firmwareversion.bin
	./firmware-imx-$_firmwareversion.bin --auto-accept
	cp -v "$_firmware_builddir"/firmware/ddr/synopsys/lpddr4*.bin $builddir/
	cp -v "$_firmware_builddir"/firmware/hdmi/cadence/signed_*imx8m.bin $builddir/

	# Disable -Werror in arm-trusted-firmware so it builds with GCC 12. The
	# version we use here is missing E=0 introduced here:
	# https://github.com/ARM-software/arm-trusted-firmware/commit/6336b07ad25cb05ca75f5a465d816af7956e0a59
	sed -i "s/-Werror//g" "$_atf_builddir"/Makefile
}

build() {
	msg "Building ARM trusted firmware"
	cd "$_atf_builddir"
	LDFLAGS="-no-warn-rwx-segment" make PLAT=imx8mp bl31
	# Overwrite default bl31 binary with one made here
	export BL31="$_atf_builddir/build/imx8mp/release/bl31.bin"
	cp -v "$_atf_builddir"/build/imx8mp/release/bl31.bin "$builddir"/

	msg "Building u-boot"
	cd $builddir

	# Phone uboot firmware
	make distclean
	make comet_defconfig
	make CROSS_COMPILE=aarch64-alpine-linux-musl- -j$(nproc --all)

	# Generate IMX image
	cp "$builddir"/spl/u-boot-spl.bin "$_imxmkimage_dir"/iMX8M/u-boot-spl.bin
	cp "$builddir"/u-boot-nodtb.bin "$_imxmkimage_dir"/iMX8M/u-boot-nodtb.bin
	cp "$builddir"/arch/arm/dts/imx8mp-mecha-comet.dtb "$_imxmkimage_dir"/iMX8M/imx8mp-mecha-comet.dtb
        cp "$builddir"/arch/arm/dts/imx8mp-mecha-comet.dtb "$_imxmkimage_dir"/iMX8M/imx8mp-mecha-comet-evk.dtb
	install -Dm755 "$builddir"/tools/mkimage "$_imxmkimage_dir"/iMX8M/mkimage_uboot
	cp "$_atf_builddir"/build/imx8mp/release/bl31.bin "$_imxmkimage_dir"/iMX8M/bl31.bin
        cp -v "$_firmware_builddir"/firmware/ddr/synopsys/lpddr4*.bin "$_imxmkimage_dir"/iMX8M/
        cp -v "$_firmware_builddir"/firmware/hdmi/cadence/signed_*imx8m.bin "$_imxmkimage_dir"/iMX8M/

        cd $_imxmkimage_dir
	make SOC=iMX8MP PLAT=imx8mp-mecha-comet flash_evk
        
	cp iMX8M/flash.bin "$builddir"/phone-boot.img
	sha512sum -b "$builddir"/phone-boot.img > "$builddir"/phone-boot.img.sha512
}

package() {
	install -D -m644 "$builddir"/phone-boot.img \
		"$pkgdir/usr/share/u-boot/comet-m/phone-boot.img"
	install -D -m644 "$builddir"/phone-boot.img.sha512 \
		"$pkgdir/usr/share/u-boot/comet-m/phone-boot.img.sha512"
	install -D -m 755 "$srcdir"/update-u-boot \
		"$pkgdir"/usr/sbin/update-u-boot
}
sha512sums="
649383c44a772b638fa3d6d9595319e2c5d8a5045981322e545c580ed21df49d6634580a997ecbda55589c53bf6c1f0c26011891d5fd278edc1890f83ff7a7ff  u-boot-imx-mecha-comet.tar.gz
2e35323b80feb392e19f127b077c21439f77cf7f67d963a7d64eb72bbfe9de4ec950f3265e175016254b4716536a08e9faa75e504ae3cd91ffb891304d13ca72  arm-trusted-firmware-1b27ee3edbb40ef9432c69ccaa744d1ac5d54c5d.tar.gz
23a16cb6ad68a3b7d0079e42d252d7413b626c16c42c4e9ea2fcc889675a8f3bf44ac86f09f3c8a880f69d5c0d8eff53ab039b3b48c388d5c27725118ebe7cf4  imx_mkimage-lf-6.6.52-2.2.0.tar.gz
332c5856dd219c076c903818227accbbaffe4b9fd0d54605e7a9d4f7c8dc5ed38285e1e65df055d1f7e3d297a48b286688bd7c4152d1d745bdb3cefd86c6a38f  firmware-imx-8.26-d4c33ab.bin
b1907626ceca8030926598413d6158ae3737f785334aa13a8e77e898a5e359f9cdda772a4e6463c1fd5c28dc0a1bb028f47a1816449c4b2e94db2274464124b1  update-u-boot
"
