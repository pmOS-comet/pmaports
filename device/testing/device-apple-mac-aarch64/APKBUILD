# Maintainer: Clayton Craft <clayton@craftyguy.net>
# Reference: <https://postmarketos.org/devicepkg>
pkgname=device-apple-mac-aarch64
pkgdesc="Apple M-series Macs"
pkgver=3
pkgrel=2
url="https://postmarketos.org"
license="MIT"
arch="aarch64"
options="!check !archcheck"
depends="
	alsa-ucm-conf-asahi
	asahi-audio
	asahi-scripts
	linux-postmarketos-asahi
	postmarketos-base
	systemd-boot
	u-boot-asahi
"
makedepends="devicepkg-dev systemd-boot"
source="
	deviceinfo
	initramfs_copy_vendorfw.sh
	initramfs_setup_vendorfw.sh
	modules-initfs
	os-installer-deploy.sh
"
subpackages="
	$pkgname-audio
	$pkgname-os-installer:os_installer
	$pkgname-vulkan
"

build() {
	devicepkg_build $startdir $pkgname
}

package() {
	devicepkg_package $startdir $pkgname

	# vendor firmware management scripts
	install -Dm755 "$srcdir"/initramfs_setup_vendorfw.sh \
		-t "$pkgdir"/usr/share/mkinitfs/hooks/
	install -Dm755 "$srcdir"/initramfs_copy_vendorfw.sh \
		-t "$pkgdir"/usr/share/mkinitfs/hooks-cleanup/

	# os-installer support
	install -Dm755 "$srcdir"/os-installer-deploy.sh \
		"$pkgdir"/etc/os-installer/deploy.sh

	# u-boot-asahi has a trigger that installs m1n1+u-boot and expects this dir to
	# exist, or else it crashes. This dir won't exist when building a new
	# install/image so we have to create it manually.
	mkdir -p "$pkgdir/boot/m1n1"
}

audio() {
	install_if="$pkgname=$pkgver-r$pkgrel postmarketos-base-ui-audio"
	depends="
		postmarketos-base-ui-audio-pipewire
	"

	mkdir -p "$subpkgdir"
}

os_installer() {
	install_if="$pkgname=$pkgver-r$pkgrel postmarketos-ui-os-installer"
	description="Support for using os-installer"
	depends="gojq"

	amove etc/os-installer/deploy.sh
}

vulkan() {
	install_if="$pkgname=$pkgver-r$pkgrel vulkan-loader"
	depends="mesa-vulkan-asahi"
	mkdir "$subpkgdir"
}

sha512sums="
ae2ad6d49ee3d0d1328f6e5a2c44daaca29d200122c5a8972b254a2504bd7712b54cb08fa15481eb667705e1c7934b3b30a614ebf478222f8b48db8f7559bcdc  deviceinfo
f111ddc0484f079af23520dcc9b4d909b55da327aec91545921a4ceafc52b21d88f37fbdb702e51ca1e49440b6afc2011ada8b681c1801f572bddc9cd34c9d9e  initramfs_copy_vendorfw.sh
11d5d6af50ed73e7e6940f7d56730f94a1bb42990d5dba9a798522060e7717c410c025b12def0345b4f43c97da268dabcb484c3004d23c1ac39b1eeaaefd2967  initramfs_setup_vendorfw.sh
d6aa23ece36ff7b393f0cc50627198584a9f052f5f900e8d44b6655c8aa2b7c7b025a00b8fef426a5541b4f20432f6249da80486ebe7597e2c4a54dc6caf467b  modules-initfs
7b9a75b2d471be7eef06d4f4b6bff64a2164fd23332311388e1a1962a63b18dfed4d2252a910302313f556c84030ef92cdca4f853f9076874776db070b1c09cc  os-installer-deploy.sh
"
