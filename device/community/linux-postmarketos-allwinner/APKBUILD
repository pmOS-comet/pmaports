# Maintainer: Arnav Singh <me@arnavion.dev>
# Co-Maintainer: Jan Jasper de Kroon <jajadekroon@gmail.com>
_flavor=postmarketos-allwinner
_config="config-$_flavor.$CARCH"
pkgname=linux-$_flavor
pkgver=6.17.5_git20251026
pkgrel=2
_tag="orange-pi-6.17-20251026-1441"
pkgdesc="Kernel fork with Pine64 patches (megi's tree, slightly patched)"
arch="aarch64 armv7"
url="https://megous.com/git/linux/"
license="GPL-2.0-only"
makedepends="
	bison
	clang
	devicepkg-dev
	findutils
	flex
	gmp-dev
	installkernel
	lld
	llvm
	mpc1-dev
	mpfr-dev
	openssl-dev
	perl
	rsync
	zstd
	bash
	"
options="!strip !check !tracedeps
	pmb:cross-native
	pmb:kconfigcheck-community
	pmb:kconfigcheck-netmount
	"
source="$pkgname-$_tag.tar.gz::https://codeberg.org/megi/linux/archive/$_tag.tar.gz
	config-$_flavor.aarch64
	config-$_flavor.armv7
	0001-dts-add-dontbeevil-pinephone-devkit.patch
	0002-dts-add-pinetab-dev-old-display-panel.patch
	0003-dts-pinetab-add-missing-ohci1.patch
	0004-dts-pinetab-make-audio-routing-consistent-with-pinep.patch
	0005-dts-pinephone-drop-modem-power-node.patch
	0006-drm-panel-simple-Add-Hannstar-TQTM070CB501.patch
	0007-ARM-dts-sun6i-Add-GoClever-Orion-70L-tablet.patch
	0008-drm-panel-simple-Add-Hannstar-HSD070IDW1-A.patch
	0009-ARM-dts-sun6i-Add-Lark-FreeMe-70.2S-tablet.patch
	0010-eMMC-workaround.patch
	0011-arm64-dts-allwinner-orangepi-3-fix-ethernet.patch
	0012-arm64-dts-sun50i-a64-pinephone-1.2-Increase-backligh.patch
	"
builddir="$srcdir/linux"

case "$CARCH" in
	aarch64*) _carch="arm64" ;;
	arm*) _carch="arm" ;;
esac


prepare() {
	default_prepare

	REPLACE_GCCH=0 \
		. downstreamkernel_prepare
}

build() {
	unset LDFLAGS
	# V=1: workaround for pma#1990
	make ARCH="$_carch" LLVM=1 \
		KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-$_flavor" \
		CFLAGS_MODULE=-fno-pic \
		DTC_FLAGS="-@" \
		V=1
}

package() {
	downstreamkernel_package "$builddir" "$pkgdir" "$_carch" "$_flavor"

	make -j1 modules_install dtbs_install \
		ARCH="$_carch" \
		LLVM=1 \
		INSTALL_MOD_STRIP=1 \
		INSTALL_MOD_PATH="$pkgdir" \
		INSTALL_DTBS_PATH="$pkgdir/boot/dtbs"
}
sha512sums="
6d8f14b11b0d50bc7e6354716a91600531a2e9385035bd277d1f241aa7515137340acd9d17e161c3d3f4b7d846f4513b80a5e93fc74bf1ee1275424e11afa8e9  linux-postmarketos-allwinner-orange-pi-6.17-20251026-1441.tar.gz
02134d0bb81019a5fdfb1d2c14b167185f174bb2d49695cc4bab944ed3363e2058a39a6d4d0c55f3baa4aac8c0df95150185f96278d9a2ec3b08f383b66d0ef1  config-postmarketos-allwinner.aarch64
928dfc0545ebe2e2ff6e86407d74f7158968a770e088dc804b99985fc5c0dab56970c4f64b845f560090456f02431a41b1d6c2f61f0862675306fb15ed9e46c9  config-postmarketos-allwinner.armv7
22d8630900ddd644e5351aecddf430782f27a83a89369f6e7e222682c909b1d0a37f6ddba2fd560a4c9306aaa285f117f3047c54435efe146c1fd06cf6c69281  0001-dts-add-dontbeevil-pinephone-devkit.patch
a342cfefa540a090f10f1c2d16e27f14db8da1c46867ea0a5c60f6cd9ead7443a9994af1e0a45e94878f7bb37c8e36cae5ce086c6afae5007d71f613190ec861  0002-dts-add-pinetab-dev-old-display-panel.patch
cb321cc103295e4091754a867e1cbf40fa918483d557d81d7e9fe2df594fd078ae6025f72c1339a93cf342e762fa82121d0225cd8c09e89234962eca1c69c129  0003-dts-pinetab-add-missing-ohci1.patch
8d3f24a251dcc08e336aeffe9d4aef4bb7ca20b265f28638116077ee50aae0ad5f912f728dc3311b7329d960da4228249c98950cff5bbe55a8f25bd29b23ca3e  0004-dts-pinetab-make-audio-routing-consistent-with-pinep.patch
5d426b43d8e26be0c83ab8e0aa1c29a5bd5bdc983e123462bce60413055e89bfacb6be46639ea3f6e6418193fe6ccb9723e69296762a0501ccf2713a4cd60988  0005-dts-pinephone-drop-modem-power-node.patch
5046b71930b0f582054b89312bb32426d37ae42f381da0b1c83874f8980a01f2db2dcfe3c1c021ae1709795b636440ddc064a26f3379191d592d128a99dda761  0006-drm-panel-simple-Add-Hannstar-TQTM070CB501.patch
524d670bc9eff2d761ebff99b8c73d55bafd6a6ac9595450ed9bf72e5fd276aff62f442b6b808312ef094a45f8af4f8a965ffb369255b9634a16ecaec6942c6a  0007-ARM-dts-sun6i-Add-GoClever-Orion-70L-tablet.patch
4cb5a7f3b8741bc709e3bb86efabb8459f4d627a0eadddec219931346172fe92c16e458d383e18ecdb62cf1965606aec866fd070cba21682d17e10a7fbad1fa5  0008-drm-panel-simple-Add-Hannstar-HSD070IDW1-A.patch
4a35e34d84805746b4af54af0e09e93296814c783ad413d6ddee543b88830042647581e58fae850b60a971902cc42c85b477d5584eb24a2f866ba4d08f98c7f6  0009-ARM-dts-sun6i-Add-Lark-FreeMe-70.2S-tablet.patch
b1ee2d222454539acda124eb57dca2a2938378909f430aac8646bfcfc3bde590a076c21ea9573777b61839a2105df3155e0603deda0aa8aa8cc94f05a5bab942  0010-eMMC-workaround.patch
ebb3d145acff253e29e70375f2e09f2ff605eaceee6b516673b7fe9ddabeb5afff27b2c14680ee8c6764c3f133dc8ff32fc7620afb1b8fab43c33825473ed825  0011-arm64-dts-allwinner-orangepi-3-fix-ethernet.patch
a602063f2e0f815c401507db952214e37e882f7f7606cd5567f430dd014f56151032befb4cb8bfbf9485319a61ac5d446f1c09d0745385fdf84aaca6b482ab7c  0012-arm64-dts-sun50i-a64-pinephone-1.2-Increase-backligh.patch
"
